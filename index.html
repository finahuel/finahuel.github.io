<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thai Cream ‚Äî Pedidos</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --bg: #fffef7;
        --primary: #892d1e;
        --secondary: #edec99;
        --light: #f9f9e0;
        --dark: #5a1d14;
        --card: #ffffff;
        --muted: #777777;
        --shadow: 0 6px 20px rgba(137, 45, 30, 0.1);
        --shadow-light: 0 4px 12px rgba(137, 45, 30, 0.08);
      }

      /* ============================
   RESET Y CONTENEDOR PRINCIPAL
============================ */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        overflow-x: hidden;
        scroll-behavior: smooth;
      }

      body {
        font-family: Inter, system-ui, "Helvetica Neue", Arial;
        background: var(--bg);
        -webkit-font-smoothing: antialiased;
        padding-top: 70px;
        color: #333;
        padding-bottom: 80px;
      }

      img {
        display: block;
        max-width: 100%;
      }

      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
      }

      /* ============================
        NAVBAR
        ============================ */
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 2px 10px rgba(137, 45, 30, 0.05);
      }

      .nav-inner {
        max-width: 1100px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      /* LOGO MEJORADO */
      .nav-brand img {
        width: 70px;
        height: 70px;
        object-fit: contain;
        background: transparent;
        padding: 0;
        filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.15));
        transition: all 0.3s ease;
      }

      .nav-brand img:hover {
        transform: scale(1.05);
        filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.2));
      }

      .nav-text {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
      }

      .nav-text strong {
        font-size: 20px;
        font-weight: 800;
        color: var(--primary);
        letter-spacing: -0.3px;
      }

      .nav-text span {
        font-size: 13px;
        color: var(--muted);
        font-weight: 500;
      }

      .nav-actions {
        display: flex;
        gap: 12px;
      }

      .social-btn {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        border: 1px solid #e2e2e2;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0;
        text-decoration: none;
        color: #333;
        position: relative;
        overflow: hidden;
      }

      .social-btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, var(--primary), var(--dark));
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1;
      }

      .social-btn:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        border-color: transparent;
      }

      .social-btn .icon {
        position: relative;
        z-index: 2;
        width: 22px;
        height: 22px;
        transition: all 0.3s ease;
      }

      .social-btn.instagram:hover .icon {
        filter: brightness(0) invert(1);
      }

      .social-btn.whatsapp:hover .icon {
        filter: brightness(0) invert(1);
      }

      .social-btn.instagram:hover::before {
        opacity: 1;
        background: linear-gradient(
          45deg,
          #405de6,
          #5851db,
          #833ab4,
          #c13584,
          #e1306c,
          #fd1d1d
        );
      }

      .social-btn.whatsapp:hover::before {
        opacity: 1;
        background: #25d366;
      }

      /* SVG icon styles */
      .instagram-icon {
        fill: #e1306c;
      }

      .whatsapp-icon {
        fill: #25d366;
      }

      .social-btn:hover .instagram-icon {
        fill: white;
      }

      .social-btn:hover .whatsapp-icon {
        fill: white;
      }

      /* ============================
        LAYOUT PRINCIPAL
        ============================ */
      .layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 25px;
        align-items: start;
        margin-top: 10px;
      }

      @media (min-width: 981px) {
        .layout {
          min-height: calc(100vh - 100px);
        }

        .sidebar {
          position: sticky;
          top: 10px;
          max-height: none; /* ‚Üê quitamos l√≠mite */
          overflow-y: visible; /* ‚Üê sin scroll interno */
        }

        /* si el carrito tiene lista interna */
        .cart-list {
          max-height: none;
          overflow: visible;
        }
      }

      /* ============================
        PRODUCTOS
        ============================ */
      .products-container {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        box-shadow: var(--shadow);
        height: fit-content;
      }

      .products-container h2 {
        margin: 0 0 8px 0;
        font-size: 24px;
        color: var(--primary);
        font-weight: 800;
      }

      .products-container .lead {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 20px;
      }

      .products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 20px;
      }

      .product {
        border-radius: 16px;
        overflow: hidden;
        background: #fff;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow-light);
      }

      .product:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(137, 45, 30, 0.15);
      }

      .product img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        background: var(--light);
      }

      .product-body {
        padding: 16px;
        display: flex;
        flex-direction: column;
        flex: 1;
      }

      .product-title {
        font-weight: 700;
        font-size: 16px;
        margin-bottom: 8px;
        color: #333;
      }

      .price {
        font-weight: 800;
        color: var(--primary);
        font-size: 18px;
        margin-bottom: 12px;
      }

      .product-foot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
      }

      /* ============================
        SIDEBAR (CARRITO + FORMULARIO)
        ============================ */
      .sidebar-card {
        background: #fff;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
      }

      .sidebar-card h3 {
        margin: 0 0 15px 0;
        font-size: 20px;
        color: var(--primary);
        font-weight: 800;
      }

      /* CARRITO */
      .cart-list {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 10px;
      }

      .cart-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
      }

      .cart-row:last-child {
        border-bottom: none;
      }

      .cart-row > div:first-child {
        flex: 1;
        padding-right: 15px;
      }

      .cart-row > div:last-child {
        text-align: right;
        min-width: 100px;
      }

      .cart-row b {
        color: #333;
        font-size: 15px;
      }

      .cart-row .small {
        font-size: 13px;
        color: var(--muted);
        margin-top: 4px;
        line-height: 1.4;
      }

      .cart-row .price {
        font-size: 16px;
        font-weight: 800;
        color: var(--primary);
      }

      .cart-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #eee;
      }

      .cart-total .label {
        font-weight: 600;
        color: #333;
      }

      .cart-total .amount {
        font-weight: 800;
        font-size: 22px;
        color: var(--primary);
      }

      /* FORMULARIO */
      .nice-form {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .form-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .form-field label {
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .nice-form input,
      .nice-form select,
      .nice-form textarea {
        width: 100%;
        padding: 12px 15px;
        border-radius: 12px;
        border: 1px solid #ddd;
        font-size: 15px;
        background: #fff;
        transition: all 0.3s;
      }

      .nice-form input:focus,
      .nice-form select:focus,
      .nice-form textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(137, 45, 30, 0.15);
        outline: none;
      }

      .time-note {
        font-size: 13px;
        color: var(--muted);
        margin-top: 4px;
      }

      .payment-msg {
        font-size: 13px;
        color: var(--primary);
        margin-top: 6px;
        font-weight: 600;
        display: none;
      }

      /* ============================
        BOTONES
        ============================ */
      .btn {
        padding: 12px 20px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, var(--dark), var(--primary));
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(137, 45, 30, 0.25);
      }

      .btn-ghost {
        background: transparent;
        border: 1px solid #ddd;
        color: #555;
      }

      .btn-ghost:hover {
        background: #f9f9f9;
        border-color: var(--primary);
        color: var(--primary);
      }

      .product .btn-primary {
        padding: 10px 18px;
        font-size: 14px;
        border-radius: 10px;
      }

      /* ============================
        FOOTER FIJO REDISE√ëADO - MEJORADO PARA M√ìVIL
        ============================ */
      .fixed-footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        padding: 12px 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 200;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }

      .fixed-footer.visible {
        transform: translateY(0);
      }

      .footer-left {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      /* BOT√ìN DE CARRITO EST√âTICO */
      .cart-total-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, var(--primary), var(--dark));
        color: white;
        padding: 10px 16px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 700;
        font-size: 16px;
        box-shadow: 0 4px 12px rgba(137, 45, 30, 0.2);
        white-space: nowrap;
        flex-shrink: 0;
      }

      .cart-total-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(137, 45, 30, 0.3);
        background: linear-gradient(135deg, var(--dark), var(--primary));
      }

      .cart-total-btn .cart-icon {
        width: 20px;
        height: 20px;
        stroke-width: 2.5;
      }

      .cart-total-btn .total-amount {
        font-weight: 800;
        font-size: 18px;
        margin-left: 4px;
      }

      .fixed-footer .footer-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: nowrap;
      }

      .fixed-footer .btn-ghost {
        padding: 10px 14px;
        font-size: 14px;
        white-space: nowrap;
      }

      .fixed-button {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        white-space: nowrap;
      }

      .fixed-button:hover {
        background: linear-gradient(135deg, var(--dark), var(--primary));
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(137, 45, 30, 0.25);
      }

      /* ============================
        MODAL DE PRODUCTOS
        ============================ */
      #modal {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 2000;
        backdrop-filter: blur(5px);
      }

      #modal .sheet {
        width: 100%;
        max-width: 600px;
        background: #fff;
        border-radius: 24px;
        padding: 25px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }

      .modal-header img {
        width: 120px;
        height: 100px;
        object-fit: cover;
        border-radius: 12px;
        flex-shrink: 0;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 22px;
        color: var(--primary);
        font-weight: 800;
      }

      .modal-section {
        margin-bottom: 25px;
      }

      .modal-section h3 {
        margin: 0 0 12px 0;
        font-size: 18px;
        color: #333;
        font-weight: 700;
      }

      .topping-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
        max-height: 160px;
        overflow-y: auto;
        padding: 5px;
      }

      .chip {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        text-align: center;
        user-select: none;
      }

      .chip:hover {
        border-color: var(--primary);
        background: var(--light);
      }

      .chip.active {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        color: white;
        border-color: transparent;
        font-weight: 600;
      }

      .sauce-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      @media (min-width: 480px) {
        .sauce-list {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      .sauce {
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #e0e0e0;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        font-size: 14px;
        user-select: none;
      }

      .sauce:hover {
        border-color: var(--primary);
        background: var(--light);
      }

      .sauce.active {
        background: var(--primary);
        color: white;
        border-color: transparent;
        font-weight: 600;
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: center;
        max-width: 200px;
      }

      .qty-btn {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: white;
        font-size: 22px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        color: #333;
      }

      .qty-btn:hover {
        background: #f5f5f5;
        border-color: var(--primary);
      }

      #modalQty {
        width: 80px;
        text-align: center;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-size: 18px;
        font-weight: 700;
        background: #fff;
        -moz-appearance: textfield;
        appearance: textfield;
      }

      #modalQty::-webkit-outer-spin-button,
      #modalQty::-webkit-inner-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
      }

      .cucharita-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #e0e0e0;
        background: #fafafa;
      }

      .cucharita-option input[type="checkbox"] {
        width: 22px;
        height: 22px;
        accent-color: var(--primary);
        cursor: pointer;
        flex-shrink: 0;
      }

      .cucharita-option label {
        font-size: 16px;
        cursor: pointer;
        flex: 1;
        color: #333;
        font-weight: 500;
      }

      .modal-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .modal-price {
        font-weight: 800;
        font-size: 24px;
        color: var(--primary);
      }

      /* ============================
        MODAL DEL MAPA
        ============================ */
      #mapModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        padding: 20px;
      }

      .map-container {
        background: white;
        border-radius: 24px;
        padding: 25px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #map {
        width: 100%;
        flex: 1;
        min-height: 400px;
        border-radius: 12px;
        margin: 15px 0;
        border: 1px solid #ddd;
      }

      .map-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 20px;
      }

      #selectedAddress {
        margin: 15px 0;
        padding: 15px;
        background: #f7f7f7;
        border-radius: 12px;
        font-size: 14px;
      }

      .open-map-btn {
        margin-top: 8px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
      }

      .address-input-container {
        position: relative;
      }

      #addressSuggestions {
        border: 1px solid #ddd;
        border-radius: 10px;
        background: white;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        width: 100%;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: none;
        margin-top: 4px;
      }

      .suggestion-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
      }

      .suggestion-item:hover {
        background-color: #f7f7f7;
      }

      /* ============================
        RESPONSIVE - MEJORADO
        ============================ */
      @media (max-width: 1100px) {
        .wrap {
          padding: 15px;
        }
      }

      @media (max-width: 980px) {
        .layout {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .sidebar {
          position: static;
          max-height: none;
        }

        .products-container,
        .sidebar-card {
          padding: 20px;
        }

        body {
          padding-bottom: 50px;
        }
      }

      @media (max-width: 768px) {
        .navbar {
          height: 65px;
          padding: 0 15px;
        }

        .nav-brand img {
          width: 55px;
          height: 55px;
        }

        .nav-text strong {
          font-size: 18px;
        }

        .social-btn {
          width: 42px;
          height: 42px;
        }

        .products {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 15px;
        }

        .product img {
          height: 120px;
        }

        .modal-header {
          flex-direction: column;
          text-align: center;
        }

        .modal-header img {
          width: 100%;
          height: 120px;
        }

        .topping-grid {
          grid-template-columns: repeat(2, 1fr);
          max-height: 200px;
        }

        .modal-actions {
          flex-direction: column;
          gap: 15px;
        }

        .modal-actions .btn {
          width: 100%;
        }

        /* FOOTER MEJORADO PARA M√ìVIL - UNA SOLA L√çNEA */
        .fixed-footer {
          padding: 10px 12px;
          flex-wrap: nowrap;
          justify-content: space-between;
          gap: 8px;
        }

        .footer-left {
          order: 1;
          flex: 1;
          min-width: 0;
          overflow: hidden;
        }

        .footer-actions {
          order: 2;
          flex: 1;
          justify-content: flex-end;
          min-width: 0;
          margin-bottom: 0;
        }

        .cart-total-btn {
          padding: 8px 12px;
          font-size: 14px;
          max-width: 140px;
          overflow: hidden;
        }

        .cart-total-btn .total-amount {
          font-size: 16px;
        }

        .fixed-footer .btn-ghost {
          padding: 8px 10px;
          font-size: 13px;
          min-width: 80px;
        }

        .fixed-button {
          padding: 8px 14px;
          font-size: 13px;
          min-width: 100px;
        }
      }

      @media (max-width: 580px) {
        .fixed-footer {
          gap: 6px;
        }

        .cart-total-btn {
          padding: 8px 10px;
          font-size: 13px;
          max-width: 120px;
        }

        .cart-total-btn .cart-icon {
          width: 16px;
          height: 16px;
        }

        .cart-total-btn .total-amount {
          font-size: 15px;
        }

        .fixed-footer .btn-ghost {
          padding: 7px 8px;
          font-size: 12px;
          min-width: 70px;
        }

        .fixed-button {
          padding: 7px 10px;
          font-size: 12px;
          min-width: 90px;
        }
      }

      @media (max-width: 480px) {
        .products {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }

        .product-body {
          padding: 12px;
        }

        .product-title {
          font-size: 15px;
        }

        .price {
          font-size: 16px;
        }

        .product .btn-primary {
          padding: 8px 12px;
          font-size: 13px;
        }

        .sauce-list {
          grid-template-columns: repeat(2, 1fr);
        }

        .nav-brand img {
          width: 50px;
          height: 50px;
        }

        .nav-text strong {
          font-size: 16px;
        }

        /* Ajustes adicionales para pantallas muy peque√±as */
        .fixed-footer {
          padding: 8px 10px;
        }

        .cart-total-btn {
          padding: 6px 8px;
          font-size: 12px;
          max-width: 110px;
        }

        .cart-total-btn .total-amount {
          font-size: 14px;
        }

        .fixed-footer .btn-ghost,
        .fixed-button {
          padding: 6px 6px;
          font-size: 12px;
        }
      }

      @media (max-width: 360px) {
        .products {
          grid-template-columns: 1fr;
        }

        .nav-text span {
          font-size: 12px;
        }

        .social-btn {
          width: 38px;
          height: 38px;
        }

        /* √öltimo ajuste para pantallas muy peque√±as */
        .cart-total-btn {
          padding: 6px 8px;
          font-size: 11px;
          max-width: 100px;
        }

        .cart-total-btn .total-amount {
          font-size: 13px;
        }
      }

      /* Ajustes generales */
      .small {
        font-size: 13px;
        color: var(--muted);
      }

      .text-center {
        text-align: center;
      }

      .mb-10 {
        margin-bottom: 10px;
      }

      .mb-15 {
        margin-bottom: 15px;
      }

      .mb-20 {
        margin-bottom: 20px;
      }

      .mt-10 {
        margin-top: 10px;
      }

      .mt-15 {
        margin-top: 15px;
      }

      .mt-20 {
        margin-top: 20px;
      }

      /* Scrollbar personalizado */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #aaa;
      }

      /* Controlamos el espaciado del bot√≥n + referencia */
      .open-map-row {
        display: flex;
        flex-direction: column;
        gap: 10px; /* ajusta a 6px / 10px si quer√©s m√°s o menos espacio */
        margin-top: 8px;
      }
      .open-map-row .open-map-btn {
        margin-top: 0px; /* evitamos doble margen */
      }
      /* ============================
  MODAL DEL MAPA - ESTILO MEJORADO
  ============================ */
      #mapModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        padding: 20px;
        backdrop-filter: blur(8px);
      }

      .map-container {
        background: var(--card);
        border-radius: 24px;
        width: 100%;
        max-width: 800px;
        height: 90vh;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 25px 60px rgba(137, 45, 30, 0.25);
        border: 1px solid rgba(137, 45, 30, 0.1);
        animation: mapModalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      @keyframes mapModalSlideIn {
        from {
          opacity: 0;
          transform: translateY(40px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .map-header {
        padding: 24px 30px 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        background: linear-gradient(135deg, #fff 0%, #fffef7 100%);
      }

      .map-header h3 {
        margin: 0;
        font-size: 22px;
        color: var(--primary);
        font-weight: 800;
        letter-spacing: -0.3px;
      }

      .map-close-btn {
        background: rgba(137, 45, 30, 0.08);
        border: none;
        font-size: 26px;
        color: var(--primary);
        cursor: pointer;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 14px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        line-height: 1;
      }

      .map-close-btn:hover {
        background: var(--primary);
        color: white;
        transform: rotate(90deg);
        box-shadow: 0 6px 20px rgba(137, 45, 30, 0.2);
      }

      .map-content-wrapper {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 0;
        padding: 25px 30px 0;
        background: var(--light);
      }

      #map {
        width: 100%;
        flex: 1;
        min-height: 350px;
        border: 2px solid rgba(137, 45, 30, 0.15);
        border-radius: 18px;
        box-shadow: var(--shadow-light);
        overflow: hidden;
        z-index: 1;
      }

      /* Estilos para el mapa de Leaflet */
      .leaflet-container {
        font-family: Inter, system-ui, "Helvetica Neue", Arial;
        border-radius: 16px !important;
      }

      .leaflet-control-zoom {
        border: none !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        border-radius: 12px !important;
        overflow: hidden;
      }

      .leaflet-control-zoom a {
        border-radius: 0 !important;
        background: white !important;
        color: var(--primary) !important;
        border: 1px solid rgba(0, 0, 0, 0.1) !important;
      }

      .leaflet-control-zoom a:hover {
        background: var(--light) !important;
      }

      .address-display {
        margin: 25px 0 0;
        padding: 22px;
        background: linear-gradient(135deg, #fff 0%, #f9f9e0 100%);
        border-radius: 18px;
        border: 1px solid rgba(137, 45, 30, 0.15);
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(137, 45, 30, 0.05);
      }

      .address-label {
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--primary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .address-label::before {
        content: "üìç";
        font-size: 18px;
      }

      .address-text {
        color: var(--dark);
        font-size: 15px;
        line-height: 1.5;
        min-height: 22px;
        font-weight: 500;
        padding: 12px 15px;
        background: white;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
      }

      .map-footer {
        padding: 25px 30px;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        background: linear-gradient(135deg, #fff 0%, #fffef7 100%);
        flex-shrink: 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.03);
      }

      .map-actions {
        display: flex;
        gap: 16px;
        justify-content: flex-end;
      }

      .map-actions .btn {
        min-width: 180px;
        font-size: 16px;
        padding: 14px 24px;
        border-radius: 14px;
        font-weight: 700;
      }

      .map-actions .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        box-shadow: 0 6px 20px rgba(137, 45, 30, 0.2);
      }

      .map-actions .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(137, 45, 30, 0.3);
      }

      .map-actions .btn-ghost {
        border: 2px solid rgba(137, 45, 30, 0.2);
        color: var(--primary);
        font-weight: 600;
      }

      .map-actions .btn-ghost:hover {
        border-color: var(--primary);
        background: rgba(137, 45, 30, 0.05);
      }

      /* Responsive para m√≥viles */
      @media (max-width: 768px) {
        #mapModal {
          padding: 15px;
        }

        .map-container {
          height: 95vh;
          max-height: 95vh;
          border-radius: 22px;
        }

        .map-header {
          padding: 20px 24px 18px;
        }

        .map-header h3 {
          font-size: 20px;
        }

        .map-close-btn {
          width: 40px;
          height: 40px;
          font-size: 24px;
        }

        .map-content-wrapper {
          padding: 20px 24px 0;
        }

        #map {
          min-height: 300px;
          border-radius: 16px;
        }

        .address-display {
          padding: 20px;
          margin-top: 20px;
          border-radius: 16px;
        }

        .address-label {
          font-size: 15px;
        }

        .address-text {
          font-size: 14px;
          padding: 10px 14px;
        }

        .map-footer {
          padding: 20px 24px;
        }

        .map-actions {
          flex-direction: column;
          gap: 12px;
        }

        .map-actions .btn {
          width: 100%;
          min-width: unset;
          padding: 14px 20px;
        }
      }

      @media (max-width: 480px) {
        .map-container {
          height: 100vh;
          max-height: 100vh;
          border-radius: 0;
          border: none;
        }

        #mapModal {
          padding: 0;
        }

        .map-header {
          padding: 18px 20px 16px;
          border-radius: 0;
        }

        .map-header h3 {
          font-size: 18px;
        }

        .map-content-wrapper {
          padding: 16px 20px 0;
        }

        #map {
          min-height: 280px;
          border-radius: 14px;
        }

        .address-display {
          padding: 18px;
          border-radius: 14px;
        }

        .map-footer {
          padding: 18px 20px;
          border-radius: 0;
        }

        .address-label {
          font-size: 14px;
        }

        .address-text {
          font-size: 13px;
        }
      }

      /* Mejora la barra de scroll para el contenido del mapa */
      .map-content-wrapper::-webkit-scrollbar {
        width: 8px;
      }

      .map-content-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .map-content-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        border-radius: 4px;
      }

      .map-content-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--dark);
      }

      /* Indicador visual para mostrar que hay m√°s contenido */
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      .scroll-indicator {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, var(--primary), var(--dark));
        color: white;
        border: none;
        border-radius: 50px;
        padding: 10px 20px;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 6px 20px rgba(137, 45, 30, 0.3);
        z-index: 1000;
        display: none;
        cursor: pointer;
        animation: pulse 2s infinite;
      }

      .scroll-indicator:hover {
        animation: none;
        transform: translateX(-50%) scale(1.05);
      }

      /* Estilo para el bot√≥n de abrir mapa en el formulario */
      .open-map-btn {
        background: rgba(137, 45, 30, 0.08) !important;
        border: 2px dashed rgba(137, 45, 30, 0.3) !important;
        color: var(--primary) !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
      }

      .open-map-btn:hover {
        background: rgba(137, 45, 30, 0.15) !important;
        border: 2px solid var(--primary) !important;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(137, 45, 30, 0.15) !important;
      }

      .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #892d1e;
        border-radius: 50%;
        width: 14px;
        height: 14px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 5px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* --- NUEVOS ESTILOS NAVBAR Y ESTADO --- */
      .nav-inner {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Distribuye: Izquierda, Centro, Derecha */
      }

      /* Estado a la izquierda */
      .status-container {
        flex: 1; /* Ocupa el espacio izquierdo */
        display: flex;
        align-items: center;
      }

      .status-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.05);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 700;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        position: relative;
      }

      /* Animaci√≥n para Abierto (Verde) */
      .status-open .status-dot {
        background: #2ecc71;
      }
      .status-open .status-dot::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: #2ecc71;
        border-radius: 50%;
        animation: status-pulse 2s infinite;
      }

      /* Animaci√≥n para Cerrado (Gris/Rojo) */
      .status-closed .status-dot {
        background: #95a5a6;
      }
      .status-closed .status-badge {
        color: #7f8c8d;
      }

      @keyframes status-pulse {
        0% {
          transform: scale(1);
          opacity: 0.8;
        }
        100% {
          transform: scale(2.8);
          opacity: 0;
        }
      }

      /* Logo al centro */
      .nav-logo-center {
        flex: 2; /* M√°s espacio para el centro */
        display: flex;
        justify-content: center;
      }

      .nav-logo-center img {
        height: 60px; /* Logo grande */
        width: auto;
        transition: transform 0.3s;
      }

      /* Redes a la derecha */
      .nav-actions {
        flex: 1;
        justify-content: flex-end;
      }

      @media (max-width: 768px) {
        .status-badge span {
          display: none;
        } /* En m√≥vil ocultamos el texto, dejamos el punto */
        .nav-logo-center img {
          height: 50px;
        }
      }
    </style>
  </head>

  <body>
    <!-- ===================================== -->
    <!-- NAVBAR CON BOTONES DE REDES SOCIALES  -->
    <!-- ===================================== -->
    <header class="navbar">
      <div class="nav-inner">
        <div class="status-container">
          <div id="businessStatus" class="status-badge">
            <div class="status-dot"></div>
            <span id="statusText">Verificando...</span>
          </div>
        </div>

        <div class="nav-logo-center">
          <img
            src="img/logosb.png"
            alt="Thai Cream"
          />
        </div>

        <div class="nav-actions">
          <a
            href="https://www.instagram.com/thaicream.posadas/"
            target="_blank"
            class="social-btn instagram"
          >
            <svg class="icon instagram-icon" viewBox="0 0 24 24">
              <path
                d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zM12 16a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 100 2.881 1.44 1.44 0 000-2.881z"
              />
            </svg>
          </a>
          <a
            href="https://wa.me/5493764223240"
            target="_blank"
            class="social-btn whatsapp"
          >
            <svg class="icon whatsapp-icon" viewBox="0 0 24 24">
              <path
                d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.89 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.743-.981z"
              />
            </svg>
          </a>
        </div>
      </div>
    </header>

    <div class="wrap">
      <div class="layout">
        <!-- COLUMNA IZQUIERDA: productos -->
        <div class="products-container">
          <h2>Eleg√≠ tus sabores</h2>
          <p class="lead">Pod√©s personalizar cada roll y agregar varios.</p>

          <div id="productsArea" class="products"></div>
        </div>

        <!-- COLUMNA DERECHA: sidebar que contiene carrito + formulario -->
        <div class="sidebar">
          <!-- PANEL: Resumen / carrito -->
          <div class="sidebar-card" id="cartSummary">
            <h3>Tu pedido</h3>
            <div id="cartList" class="cart-list">
              <div
                class="small text-center"
                style="padding: 20px 0; color: var(--muted)"
              >
                No hay items todav√≠a
              </div>
            </div>

            <div class="cart-total">
              <div class="label">Total</div>
              <div id="total" class="amount">$0</div>
            </div>
          </div>

          <!-- FORMULARIO (debajo del carrito) -->
          <div id="customerForm" class="sidebar-card nice-form">
            <h3>Datos del cliente</h3>

            <div class="form-field">
              <label>Nombre</label>
              <input id="custName" type="text" placeholder="Tu nombre" />
            </div>

            <div class="form-field">
              <label>Tel√©fono</label>
              <input id="custPhone" type="tel" placeholder="Ej: 3764xxxxxx" />
            </div>

            <div class="form-field">
              <label>Retiro o Entrega</label>
              <select id="deliveryMode">
                <option value="pickup">Retiro</option>
                <option value="delivery">Env√≠o a domicilio</option>
              </select>
            </div>

            <div id="addressBlock" class="form-field" style="display: none">
              <label>Direcci√≥n de entrega</label>
              <div class="address-input-container">
                <input
                  id="custAddress"
                  type="text"
                  placeholder="Comienza a escribir tu direcci√≥n..."
                  autocomplete="off"
                />
                <input type="hidden" id="custLat" />
                <input type="hidden" id="custLng" />
                <input type="hidden" id="orderId" />
                <div id="addressSuggestions"></div>
              </div>
              <div
                class="open-map-row"
                style="
                  display: flex;
                  flex-direction: column;
                  gap: 8px;
                  margin-top: 8px;
                "
              >
                <button
                  type="button"
                  id="openMapBtn"
                  class="btn btn-ghost open-map-btn"
                  style="
                    background: rgba(137, 45, 30, 0.08);
                    border: 2px dashed rgba(137, 45, 30, 0.3);
                    color: var(--primary);
                    font-weight: 600;
                  "
                >
                  <span style="font-size: 18px; margin-right: 8px">üìç</span>
                  Seleccionar en el mapa
                </button>

                <div class="form-field" style="margin: 0">
                  <label>Referencia (opcional)</label>
                  <input
                    id="custRef"
                    type="text"
                    placeholder="Ej:Departamento 2B, Port√≥n negro, timbre 'P√©rez'"
                  />
                </div>
              </div>
            </div>

            <div class="form-field">
              <label>M√©todo de pago</label>
              <select id="paymentMethod">
                <option value="cash">Efectivo</option>
                <option value="transfer">Transferencia</option>
              </select>

              <div id="paymentNotice" class="payment-msg">
                Para env√≠os solo aceptamos transferencia previa.
              </div>
            </div>

            <!-- Campo cup√≥n -->
            <div class="sidebar-card">
              <h3>Cup√≥n de Descuento</h3>
              <div
                class="nice-form"
                style="display: flex; flex-direction: row; gap: 10px"
              >
                <input
                  type="text"
                  id="couponInput"
                  placeholder="Ingres√° tu c√≥digo"
                  style="flex: 1; margin: 0"
                />
                <button
                  type="button"
                  id="applyCouponBtn"
                  class="btn btn-primary"
                  onclick="handleApplyCoupon()"
                  style="padding: 10px 15px"
                >
                  Aplicar
                </button>
              </div>
              <div
                id="couponMessage"
                style="margin-top: 10px; font-size: 14px; font-weight: 600"
              ></div>
            </div>

            <div class="form-field">
              <label>Notas (opcional)</label>
              <textarea
                id="custNotes"
                rows="3"
                placeholder="Ej: sin az√∫car / venir a tal hora"
              ></textarea>
            </div>

            <button
              id="checkoutBtn2"
              class="btn btn-primary"
              style="width: 100%; margin-top: 10px"
            >
              Enviar pedido
            </button>
          </div>
        </div>
        <!-- FIN SIDEBAR -->
      </div>
      <!-- END layout -->
    </div>
    <!-- END wrap -->

    <!-- Footer fijo redise√±ado -->
    <div class="fixed-footer" id="fixedFooter">
      <div class="footer-left">
        <!-- Bot√≥n de carrito est√©tico que lleva al resumen del carrito -->
        <button id="footerCartBtn" class="cart-total-btn" title="Ver tu pedido">
          <svg
            class="cart-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <path
              d="M9 22C9.55228 22 10 21.5523 10 21C10 20.4477 9.55228 20 9 20C8.44772 20 8 20.4477 8 21C8 21.5523 8.44772 22 9 22Z"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M20 22C20.5523 22 21 21.5523 21 21C21 20.4477 20.5523 20 20 20C19.4477 20 19 20.4477 19 21C19 21.5523 19.4477 22 20 22Z"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M1 1H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 6H6"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span id="fixedTotal" class="total-amount">$0</span>
        </button>
      </div>

      <div class="footer-actions">
        <button id="footerAddBtn" class="btn btn-ghost" title="Ver productos">
          Productos
        </button>
        <button id="fixedSendBtn" class="fixed-button">Enviar pedido</button>
      </div>
    </div>

    <!-- Modal para personalizar productos -->
    <div id="modal">
      <div class="sheet">
        <div class="modal-header">
          <img id="modalImg" src="" />
          <h2 id="modalTitle"></h2>
        </div>

        <div class="modal-section">
          <h3>Toppings</h3>
          <div id="modalToppings" class="topping-grid"></div>
          <div class="small mt-10">El primer topping es gratis</div>
        </div>

        <div class="modal-section">
          <h3>Salsas</h3>
          <div id="modalSauces" class="sauce-list">
            <div class="sauce" data-s="Chocolate">Chocolate</div>
            <div class="sauce" data-s="Dulce de leche">Dulce de leche</div>
            <div class="sauce" data-s="Frutilla">Frutilla</div>
            <div class="sauce" data-s="Caramelo">Caramelo</div>
          </div>
        </div>

        <div class="modal-section">
          <h3>Cantidad</h3>
          <div class="quantity-selector">
            <button id="decreaseQty" type="button" class="qty-btn">-</button>
            <input id="modalQty" type="number" min="1" value="1" />
            <button id="increaseQty" type="button" class="qty-btn">+</button>
          </div>
        </div>

        <div class="modal-section">
          <h3>Cucharita</h3>
          <div class="cucharita-option">
            <input type="checkbox" id="cucharitaCheckbox" />
            <label for="cucharitaCheckbox">S√≠, incluir cucharita</label>
          </div>
        </div>

        <div class="modal-actions">
          <div id="modalLinePrice" class="modal-price">$0</div>
          <div style="display: flex; gap: 12px">
            <button class="btn btn-ghost" onclick="closeModal()">
              Cancelar
            </button>
            <button id="addToCartBtn" class="btn btn-primary">
              Agregar al carrito
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para el mapa - VERSI√ìN RESPONSIVE -->
    <div id="mapModal">
      <div class="map-container">
        <div class="map-header">
          <h3>Seleccion√° tu ubicaci√≥n en el mapa</h3>
          <button id="closeMap" class="map-close-btn" aria-label="Cerrar">
            √ó
          </button>
        </div>

        <div class="map-content-wrapper">
          <div id="map"></div>

          <div id="selectedAddress" class="address-display">
            <div class="address-label">Direcci√≥n seleccionada:</div>
            <div id="addressText" class="address-text">
              Hac√© clic en el mapa para seleccionar una ubicaci√≥n
            </div>
          </div>
        </div>

        <div class="map-footer">
          <div class="map-actions">
            <button id="confirmAddress" class="btn btn-primary">
              Usar esta direcci√≥n
            </button>
            <button class="btn btn-ghost" id="closeMapBottom">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======================= -->
    <!--        JAVASCRIPT       -->
    <!-- ======================= -->

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      /* CONFIG */
      const PHONE = "5493764800072";
      const BASE_PRICE_DEFAULT = 2500;
      const TOPPING_EXTRA_PRICE = 300;

      /* Productos (con misma imagen) */
      const flavors = [
        { id: "oreo", name: "Oreo", price: 2500, img: "img/oreo.jpg" },
        { id: "dura", name: "Durazno", price: 2500, img: "img/durazno.jpg" },
        { id: "fruit", name: "Frutilla", price: 2500, img: "img/frutilla.jpg" },
        { id: "chocot", name: "Chocotorta", price: 2500, img: "img/chocolina.jpg" },
        { id: "pepi", name: "Pepitos", price: 2500, img: "img/pepitos.jpg" },
        { id: "mara", name: "Maracuya", price: 2500, img: "img/maracuya.jpg" },
        { id: "bana", name: "Banana", price: 2500, img: "img/banana.jpg" },
      ];

      const toppings = [
        "Man√≠",
        "Gomitas",
        "Chips de chocolate",
        "Oreo",
        "Rocklets",
        "Coco rallado",
        "Merenguitos",
        "Pepitos",
        "Chocolinas",
      ];

      let cart = [];
      let editingItemId = null;
      let currentFlavor = null;
      let isSubmitting = false;

      // Variables para el mapa
      let map = null;
      let marker = null;
      let selectedLocation = null;
      let selectedAddress = "";

      /* Helpers */
      function $(s) {
        return document.querySelector(s);
      }
      function $$(s) {
        return document.querySelectorAll(s);
      }
      function fmt(n) {
        return "$" + Number(n).toLocaleString("es-AR");
      }

      /* Funci√≥n simple: mostrar footer solo si hay productos */
      function updateFooter() {
        const footer = document.getElementById("fixedFooter");
        const body = document.body;

        if (!footer) return;

        if (cart.length > 0) {
          footer.classList.add("visible");
          body.classList.add("footer-visible");
        } else {
          footer.classList.remove("visible");
          body.classList.remove("footer-visible");
        }
      }

      /* Render productos */
      function renderProducts() {
        const area = $("#productsArea");
        area.innerHTML = "";
        flavors.forEach((f) => {
          const box = document.createElement("div");
          box.className = "product";
          box.innerHTML = `
            <img src="${
              f.img
            }" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Helado+Tailand√©s'">
            <div class="product-body">
                <div class="product-title">${f.name}</div>
                <div class="price">${fmt(f.price)}</div>
                <div class="product-foot">
                    <button class="btn btn-primary" onclick="startNewModal('${
                      f.id
                    }','${f.name}')">Armar</button>
                </div>
            </div>
        `;
          area.appendChild(box);
        });
      }

      // Helper: abrir modal para CREAR un nuevo √≠tem
      function startNewModal(id, name) {
        editingItemId = null;
        openModal(id, name);
      }

      // Modal para personalizar
      function openModal(id, name) {
        currentFlavor = flavors.find((f) => f.id === id);

        $("#modalTitle").textContent = name;
        $("#modalImg").src = currentFlavor.img;
        $("#modalQty").value = 1;

        // Configurar botones de cantidad
        const decreaseBtn = $("#decreaseQty");
        const increaseBtn = $("#increaseQty");
        const qtyInput = $("#modalQty");

        decreaseBtn.onclick = () => {
          let current = parseInt(qtyInput.value);
          if (current > 1) {
            qtyInput.value = current - 1;
            updateModalPrice();
          }
        };

        increaseBtn.onclick = () => {
          let current = parseInt(qtyInput.value);
          qtyInput.value = current + 1;
          updateModalPrice();
        };

        // toppings
        const t = $("#modalToppings");
        t.innerHTML = "";
        toppings.forEach((tp) => {
          const el = document.createElement("div");
          el.className = "chip";
          el.innerHTML = tp;
          el.addEventListener("click", function () {
            this.classList.toggle("active");
            updateModalPrice();
          });
          t.appendChild(el);
        });

        // sauces
        $("#modalSauces")
          .querySelectorAll(".sauce")
          .forEach((s) => {
            s.classList.remove("active");
            s.onclick = () => {
              $("#modalSauces")
                .querySelectorAll(".sauce")
                .forEach((x) => x.classList.remove("active"));
              s.classList.add("active");
              updateModalPrice();
            };
          });

        // Resetear cucharita
        $("#cucharitaCheckbox").checked = false;

        // Resetear toppings si estaba editando
        if (editingItemId) {
          const it = cart.find((x) => x.id === editingItemId);
          if (it && it.toppings) {
            $$("#modalToppings .chip").forEach((chip) => {
              if (it.toppings.includes(chip.textContent)) {
                chip.classList.add("active");
              }
            });
          }
        }

        updateModalPrice();

        $("#modal").style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        $("#modal").style.display = "none";
        document.body.style.overflow = "auto";
      }

      function updateModalPrice() {
        const qty = Math.max(1, parseInt($("#modalQty").value || "1"));
        const checked = [
          ...$("#modalToppings").querySelectorAll(".chip.active"),
        ].map((i) => i.textContent);
        const extra = Math.max(0, checked.length - 1) * TOPPING_EXTRA_PRICE;
        $("#modalLinePrice").textContent = fmt(
          (currentFlavor.price + extra) * qty
        );
      }

      /* Add to cart */
      $("#addToCartBtn").onclick = () => {
        const qty = Math.max(1, parseInt($("#modalQty").value || "1"));
        const selectedToppings = [
          ...$("#modalToppings").querySelectorAll(".chip.active"),
        ].map((i) => i.textContent);
        const sauceEl = $("#modalSauces").querySelector(".sauce.active");
        const sauce = sauceEl ? sauceEl.dataset.s : "";
        const cucharita = $("#cucharitaCheckbox").checked;

        const extraPerUnit =
          Math.max(0, selectedToppings.length - 1) * TOPPING_EXTRA_PRICE;
        const itemTotal = (currentFlavor.price + extraPerUnit) * qty;

        if (editingItemId) {
          const it = cart.find((x) => x.id === editingItemId);
          it.qty = qty;
          it.toppings = selectedToppings;
          it.sauce = sauce;
          it.cucharita = cucharita;
          it.unitPrice = currentFlavor.price;
        } else {
          cart.push({
            id: "i" + Date.now(),
            flavorName: currentFlavor.name,
            flavorId: currentFlavor.id,
            qty: qty,
            toppings: selectedToppings,
            sauce: sauce,
            cucharita: cucharita,
            unitPrice: currentFlavor.price,
          });
        }

        closeModal();
        renderCart();
      };

      /* Render cart */
      function calcItemTotal(it) {
        const extra = Math.max(0, it.toppings.length - 1) * TOPPING_EXTRA_PRICE;
        return (it.unitPrice + extra) * it.qty;
      }

      function renderCart() {
        const list = $("#cartList");
        let totalPedido = 0;

        // Limpiamos la lista
        list.innerHTML = "";

        cart.forEach((it) => {
          const itemSubtotal = calcItemTotal(it);
          totalPedido += itemSubtotal;

          const row = document.createElement("div");
          row.className = "cart-row";
          row.innerHTML = `
      <div>
        <b>${it.qty}√ó ${it.flavorName}</b>
        <div class="small">
          Toppings: ${it.toppings.join(", ") || "Ninguno"}<br>
          Salsa: ${it.sauce || "Sin salsa"}
        </div>
      </div>
      <div>
        <div class="price">${fmt(itemSubtotal)}</div>
        <button class="btn-remove" onclick="removeItem('${
          it.id
        }')">Eliminar</button>
      </div>
    `;
          list.appendChild(row);
        });

        // --- L√ìGICA DE VISUALIZACI√ìN DE DESCUENTO ---
        const totalFinal = Math.max(0, totalPedido - appliedDiscount);

        // Actualizamos los textos en pantalla
        // Si hay descuento, lo mostramos debajo del total
        if (appliedDiscount > 0) {
          const discountRow = document.createElement("div");
          discountRow.className = "cart-total";
          discountRow.style.color = "green";
          discountRow.style.borderTop = "none";
          discountRow.style.marginTop = "0";
          discountRow.innerHTML = `
      <span class="label">Descuento (${appliedCouponCode}):</span>
      <span class="amount">-${fmt(appliedDiscount)}</span>
    `;
          list.appendChild(discountRow);
        }

        // El total principal de la tarjeta
        document.getElementById("total").innerText = fmt(totalFinal);

        // El total del bot√≥n flotante (si existe)
        const fixedTotal = document.getElementById("fixedTotal");
        if (fixedTotal) fixedTotal.innerText = fmt(totalFinal);

        updateFooter();
      }

      function editItem(id) {
        editingItemId = id;
        const it = cart.find((x) => x.id === id);
        openModal(it.flavorId, it.flavorName);

        $("#modalQty").value = it.qty;
        $("#cucharitaCheckbox").checked = it.cucharita || false;

        // sauce
        $("#modalSauces")
          .querySelectorAll(".sauce")
          .forEach((s) => {
            if (s.dataset.s === it.sauce) s.classList.add("active");
          });

        updateModalPrice();
      }

      function removeItem(id) {
        cart = cart.filter((x) => x.id !== id);
        renderCart();
      }

      /* Delivery select: direcci√≥n + reglas de pago + hora */
      $("#deliveryMode").onchange = () => {
        const mode = $("#deliveryMode").value;
        const addr = $("#addressBlock");

        const pay = document.getElementById("paymentMethod");
        const notice = document.getElementById("paymentNotice");
        const cashOpt = pay.querySelector('option[value="cash"]');

        // Mostrar/ocultar direcci√≥n
        addr.style.display = mode === "delivery" ? "block" : "none";
      };

      /* ============================================
        FUNCIONALIDAD DE DIRECCI√ìN CON OPENSTREETMAP
        ============================================ */

      // Autocompletado de direcciones usando Nominatim
      let addressTimeout = null;
      $("#custAddress").addEventListener("input", function (e) {
        const query = e.target.value.trim();

        if (addressTimeout) {
          clearTimeout(addressTimeout);
        }

        if (query.length < 3) {
          $("#addressSuggestions").style.display = "none";
          return;
        }

        addressTimeout = setTimeout(() => {
          searchAddresses(query);
        }, 300);
      });

      document.addEventListener("click", function (e) {
        if (!e.target.closest(".address-input-container")) {
          $("#addressSuggestions").style.display = "none";
        }
      });

      function searchAddresses(query) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
          query + ", Posadas, Misiones, Argentina"
        )}&limit=5&addressdetails=1`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            displayAddressSuggestions(data);
          })
          .catch((error) => {
            console.error("Error buscando direcciones:", error);
          });
      }

      function displayAddressSuggestions(addresses) {
        const container = $("#addressSuggestions");
        container.innerHTML = "";

        if (addresses.length === 0) {
          container.style.display = "none";
          return;
        }

        addresses.forEach((addr) => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = addr.display_name;
          div.addEventListener("click", function () {
            $("#custAddress").value = addr.display_name;
            container.style.display = "none";

            selectedLocation = {
              lat: parseFloat(addr.lat),
              lng: parseFloat(addr.lon),
            };
            // usar shorthand
            const short =
              formatShortAddress(addr.address || {}) || addr.display_name;
            selectedAddress = short;

            // guardar hidden fields
            const latEl = document.getElementById("custLat");
            const lngEl = document.getElementById("custLng");
            if (latEl) latEl.value = selectedLocation.lat;
            if (lngEl) lngEl.value = selectedLocation.lng;
          });

          container.appendChild(div);
        });

        container.style.display = "block";
      }

      // Inicializar mapa
      function initMap() {
        const posadasCoords = [-27.3671, -55.8961];

        map = L.map("map").setView(posadasCoords, 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        marker = L.marker(posadasCoords, { draggable: true }).addTo(map);
        selectedLocation = { lat: posadasCoords[0], lng: posadasCoords[1] };

        updateAddressFromMarker();

        marker.on("dragend", function (e) {
          selectedLocation = {
            lat: e.target.getLatLng().lat,
            lng: e.target.getLatLng().lng,
          };
          updateAddressFromMarker();
        });

        map.on("click", function (e) {
          selectedLocation = {
            lat: e.latlng.lat,
            lng: e.latlng.lng,
          };
          marker.setLatLng(e.latlng);
          updateAddressFromMarker();
        });
      }

      function formatShortAddress(addressObj) {
        if (!addressObj) return "";
        // intenta armar "Calle 9 de Julio 123, Barrio XYZ, Posadas, 3300"
        const number = addressObj.house_number || "";
        const road =
          addressObj.road || addressObj.pedestrian || addressObj.cycleway || "";
        const neighbourhood =
          addressObj.suburb ||
          addressObj.neighbourhood ||
          addressObj.village ||
          "";
        const city =
          addressObj.city ||
          addressObj.town ||
          addressObj.village ||
          addressObj.county ||
          "";
        const state = addressObj.state || "";
        const postcode = addressObj.postcode || "";
        const parts = [];
        if (road) parts.push((number ? number + " " : "") + road);
        if (neighbourhood) parts.push(neighbourhood);
        if (city) parts.push(city);
        if (state) parts.push(state);
        if (postcode) parts.push(postcode);
        const short = parts.filter(Boolean).join(", ");
        return short || "";
      }

      function updateAddressFromMarker() {
        if (!selectedLocation) return;

        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedLocation.lat}&lon=${selectedLocation.lng}&zoom=18&addressdetails=1`;

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            if (data) {
              const full = data.display_name || "";
              const addrObj = data.address || {};
              const short = formatShortAddress(addrObj) || full;

              // variables globales (√∫tiles)
              selectedAddressFull = full;
              selectedAddress = short; // lo usamos en el form y whatsapp

              // mostrar en el modal (preview)
              const t = $("#addressText");
              if (t) t.textContent = short || full;

              // guardar coords en hidden inputs si existen
              const latEl = document.getElementById("custLat");
              const lngEl = document.getElementById("custLng");
              if (latEl) latEl.value = selectedLocation.lat;
              if (lngEl) lngEl.value = selectedLocation.lng;
            }
          })
          .catch((error) => {
            console.error("Error obteniendo direcci√≥n:", error);
            const t = $("#addressText");
            if (t)
              t.textContent =
                "Error obteniendo la direcci√≥n. Por favor, intent√° nuevamente.";
          });
      }

      // Abrir modal del mapa
      $("#openMapBtn").addEventListener("click", function () {
        $("#mapModal").style.display = "flex";
        document.body.style.overflow = "hidden";

        if (!map) {
          initMap();
        }
      });

      // Cerrar modal del mapa
      $("#closeMap").addEventListener("click", function () {
        $("#mapModal").style.display = "none";
        document.body.style.overflow = "auto";
      });

      // Confirmar direcci√≥n seleccionada en el mapa
      // Confirmar direcci√≥n seleccionada en el mapa
      $("#confirmAddress").addEventListener("click", function () {
        if (selectedAddress) {
          $("#custAddress").value = selectedAddress;
          $("#mapModal").style.display = "none";
          document.body.style.overflow = "auto";
        } else {
          alert("Por favor, seleccion√° una ubicaci√≥n en el mapa.");
        }
      });

      $("#mapModal").addEventListener("click", function (e) {
        if (e.target.id === "mapModal") {
          $("#mapModal").style.display = "none";
          document.body.style.overflow = "auto";
        }
      });

      /* WhatsApp */
      async function sendWhatsApp() {
        if (isSubmitting) return;
        isSubmitting = true;

        const nameEl = document.getElementById("custName");
        const phoneEl = document.getElementById("custPhone");
        let name = nameEl ? nameEl.value.trim() : "";
        let phone = phoneEl ? phoneEl.value.trim() : "";

        if (!name || !phone) {
          alert("Por favor, complet√° nombre y tel√©fono.");
          isSubmitting = false;
          return;
        }

        let mode = $("#deliveryMode").value;
        let address = $("#custAddress").value.trim();
        let ref = $("#custRef").value.trim();
        let pay = $("#paymentMethod").value;
        let notes = $("#custNotes").value.trim();
        const orderId = generateOrderId();

        // --- C√ÅLCULO DE TOTALES ---
        const subtotalPedido = cart.reduce((s, it) => s + calcItemTotal(it), 0);
        const totalFinal = Math.max(0, subtotalPedido - appliedDiscount);

        // --- CONSTRUIR MENSAJE PARA WHATSAPP ---
        let text = "üç¶ *Thai Cream - NUEVO PEDIDO* üç¶\n";
        text += `üÜî *Pedido:* ${orderId}\n\n`;
        text += "*Productos:*\n";

        cart.forEach((it, i) => {
          text += `${i + 1}) ${it.qty}√ó ${it.flavorName}\n`;
          text += `   Toppings: ${it.toppings.join(", ") || "Sin toppings"}\n`;
          text += `   Salsa: ${it.sauce || "Sin salsa"}\n`;
          text += `   Subtotal: ${fmt(calcItemTotal(it))}\n\n`;
        });

        text += `--------------------------\n`;
        text += `*Subtotal:* ${fmt(subtotalPedido)}\n`;

        if (appliedDiscount > 0) {
          text += `*Descuento (${appliedCouponCode}):* -${fmt(
            appliedDiscount
          )}\n`;
        }

        text += `*TOTAL A PAGAR: ${fmt(totalFinal)}*\n`;
        text += `--------------------------\n\n`;

        text += `üë§ *Cliente:* ${name}\n`;
        text += `üìû *Tel:* ${phone}\n`;
        text += `üõµ *Modo:* ${
          mode === "delivery" ? "Env√≠o a domicilio" : "Retiro"
        }\n`;

        if (mode === "delivery") {
          text += `üìç *Direcci√≥n:* ${address}\n`;
          if (ref) text += `üè† *Ref:* ${ref}\n`;
        }

        text += `üí≥ *Pago:* ${pay}\n`;
        if (notes) text += `üìù *Notas:* ${notes}\n`;

        // --- ENVIAR DATOS A GOOGLE SHEETS ---
        // IMPORTANTE: Aqu√≠ enviamos los datos que tu Apps Script espera
        const orderData = {
          orderId: orderId,
          name: name,
          phone: phone,
          mode: mode,
          address: address + (ref ? " - Ref: " + ref : ""),
          lat: $("#custLat").value,
          lng: $("#custLng").value,
          items: cart,
          subtotal: subtotalPedido,
          discountAmount: appliedDiscount, // <--- Esto es vital para el descuento
          couponCode: appliedCouponCode, // <--- Esto es vital para restar el cup√≥n
          payment: pay,
          notes: notes,
          status: "new",
        };

        try {
          // Usamos fetch normal para asegurar que llegue la data
          fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors", // Para evitar errores de dominio, aunque no podamos leer la respuesta
            body: JSON.stringify(orderData),
          });

          // Abrir WhatsApp
          const waUrl = `https://wa.me/${PHONE}?text=${encodeURIComponent(
            text
          )}`;
          window.open(waUrl, "_blank");
        } catch (err) {
          console.error("Error al guardar en Sheets:", err);
          alert(
            "Hubo un error al procesar el pedido en el servidor, pero intentaremos enviarlo por WhatsApp igual."
          );
        } finally {
          isSubmitting = false;
        }
      }

      /* Funciones de scroll */
      function scrollToProducts() {
        const productsSection = document.querySelector(".layout");
        if (productsSection) {
          productsSection.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }

      function scrollToCart() {
        const el = document.getElementById("cartSummary");
        if (el) {
          el.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
          el.style.boxShadow = "0 0 0 3px rgba(137, 45, 30, 0.3)";
          setTimeout(() => {
            el.style.boxShadow = "";
          }, 1500);
        }
      }

      function scrollToForm() {
        const el = document.getElementById("customerForm");
        if (el) {
          el.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
          el.style.boxShadow = "0 0 0 3px rgba(137, 45, 30, 0.3)";
          setTimeout(() => {
            el.style.boxShadow = "";
          }, 1500);
        }
      }

      /* INIT */
      document.addEventListener("DOMContentLoaded", function () {
        // Hook botones del footer
        const addBtn = document.getElementById("footerAddBtn");
        if (addBtn) addBtn.addEventListener("click", scrollToProducts);

        // Bot√≥n de carrito en el footer - ahora lleva al resumen del carrito
        const cartBtn = document.getElementById("footerCartBtn");
        if (cartBtn) {
          cartBtn.addEventListener("click", scrollToCart);
        }

        // Solo un event listener para el bot√≥n fijo
        const fixedSendBtn = document.getElementById("fixedSendBtn");
        if (fixedSendBtn) {
          fixedSendBtn.removeEventListener("click", sendWhatsApp);
          fixedSendBtn.addEventListener("click", sendWhatsApp);
        }

        // Solo un event listener para el bot√≥n del formulario
        const checkoutBtn2 = document.getElementById("checkoutBtn2");
        if (checkoutBtn2) {
          checkoutBtn2.removeEventListener("click", sendWhatsApp);
          checkoutBtn2.addEventListener("click", sendWhatsApp);
        }

        // Inicializar componentes
        renderProducts();
        renderCart();
        updateFooter();

        // Inicializar el selector de modo de entrega para configurar correctamente el campo de hora
        $("#deliveryMode").onchange();
      });

      // HELPER seguro para leer inputs (evita crashes si el elemento no existe)
      function val(id) {
        const el = document.getElementById(id);
        return el ? el.value.trim() : "";
      }

      function generateOrderId() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, "0");
        const d = String(now.getDate()).padStart(2, "0");
        const h = String(now.getHours()).padStart(2, "0");
        const min = String(now.getMinutes()).padStart(2, "0");
        return `${y}${m}${d}-${h}${min}`;
      }
      // Funci√≥n para verificar si se necesita scroll
      function checkMapScroll() {
        const mapContent = document.querySelector(".map-content-wrapper");
        const mapContainer = document.querySelector(".map-container");
        const mapFooter = document.querySelector(".map-footer");

        if (!mapContent || !mapContainer) return;

        const contentHeight = mapContent.scrollHeight;
        const containerHeight = mapContainer.clientHeight;
        const headerHeight = document.querySelector(".map-header").clientHeight;
        const footerHeight = mapFooter.clientHeight;

        const availableHeight = containerHeight - headerHeight - footerHeight;

        // Si el contenido es m√°s alto que el espacio disponible, hacer scrollable
        if (contentHeight > availableHeight) {
          mapContent.style.overflowY = "auto";
          mapContent.style.maxHeight = availableHeight + "px";
        } else {
          mapContent.style.overflowY = "visible";
          mapContent.style.maxHeight = "none";
        }
      }

      // Funci√≥n para inicializar el mapa con ajustes responsive
      function initMap() {
        const posadasCoords = [-27.3671, -55.8961];

        map = L.map("map").setView(posadasCoords, 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        marker = L.marker(posadasCoords, { draggable: true }).addTo(map);
        selectedLocation = { lat: posadasCoords[0], lng: posadasCoords[1] };

        updateAddressFromMarker();

        marker.on("dragend", function (e) {
          selectedLocation = {
            lat: e.target.getLatLng().lat,
            lng: e.target.getLatLng().lng,
          };
          updateAddressFromMarker();
        });

        map.on("click", function (e) {
          selectedLocation = {
            lat: e.latlng.lat,
            lng: e.latlng.lng,
          };
          marker.setLatLng(e.latlng);
          updateAddressFromMarker();
        });

        // Ajustar el mapa despu√©s de que se cargue
        setTimeout(() => {
          map.invalidateSize();
          checkMapScroll();
        }, 300);
      }

      // Modificar el evento de abrir el mapa
      $("#openMapBtn").addEventListener("click", function () {
        $("#mapModal").style.display = "flex";
        document.body.style.overflow = "hidden";

        // Peque√±o delay para que el DOM se renderice
        setTimeout(() => {
          if (!map) {
            initMap();
          } else {
            map.invalidateSize();
          }

          // Verificar scroll despu√©s de que todo est√© cargado
          setTimeout(checkMapScroll, 100);
        }, 50);
      });

      // Agregar eventos para cerrar el mapa
      $("#closeMap").addEventListener("click", function () {
        $("#mapModal").style.display = "none";
        document.body.style.overflow = "auto";
      });

      $("#closeMapBottom").addEventListener("click", function () {
        $("#mapModal").style.display = "none";
        document.body.style.overflow = "auto";
      });

      // Cerrar al hacer clic fuera del contenido
      $("#mapModal").addEventListener("click", function (e) {
        if (e.target.id === "mapModal") {
          $("#mapModal").style.display = "none";
          document.body.style.overflow = "auto";
        }
      });

      // Recalcular scroll al cambiar tama√±o de ventana
      window.addEventListener("resize", checkMapScroll);

      // --- VARIABLES GLOBALES PARA CUPONES ---
      let appliedDiscount = 0;
      let appliedCouponCode = "";

      const WEB_APP_URL =
        "https://script.google.com/macros/s/AKfycbyjvFMLJxJBpvY0OIrFtNhQ0aP3GhTYI6Gr7AII4gdeUC2QJlE96hpkwcyavEClNu1XlA/exec"; // <--- ASEG√öRATE DE PONER TU URL REAL

      async function handleApplyCoupon() {
        const btn = document.getElementById("applyCouponBtn");
        const input = document.getElementById("couponInput");
        const msg = document.getElementById("couponMessage");
        const code = input.value.trim().toUpperCase();

        if (!code) {
          alert("Por favor, ingres√° un c√≥digo.");
          return;
        }

        // --- ANIMACI√ìN DE CARGA ---
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span>...';
        msg.innerText = "Validando...";
        msg.style.color = "var(--muted)";

        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "validateCoupon", code: code }),
          });

          const result = await response.json();

          if (result.status === "ok") {
            // FIX: Obtenemos el total usando el ID correcto de tu HTML ("total")
            const totalTexto = document.getElementById("total").innerText;
            let subtotalActual =
              parseFloat(
                totalTexto.replace("$", "").replace(".", "").replace(",", ".")
              ) || 0;

            if (result.data.type === "PERCENT") {
              appliedDiscount = subtotalActual * (result.data.value / 100);
            } else {
              appliedDiscount = result.data.value;
            }

            appliedCouponCode = code;

            msg.innerText = `¬°Cup√≥n ${code} aplicado! Descuento: $${appliedDiscount.toLocaleString(
              "es-AR"
            )}`;
            msg.style.color = "green";

            // Refrescamos el carrito para que se vea el nuevo total
            renderCart();
          } else {
            appliedDiscount = 0;
            appliedCouponCode = "";
            msg.innerText = "‚ùå " + result.message;
            msg.style.color = "red";
            renderCart(); // Para limpiar si hab√≠a uno antes
          }
        } catch (error) {
          console.error("Error validando cup√≥n:", error);
          alert(
            "Error al conectar con el servidor. Revis√° tu URL de Apps Script."
          );
          msg.innerText = "";
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      // Funci√≥n para verificar si el negocio est√° abierto
      async function updateBusinessStatus() {
        const container = document.getElementById("businessStatus");
        const text = document.getElementById("statusText");

        try {
          const response = await fetch(WEB_APP_URL, {
            method: "POST",
            body: JSON.stringify({ action: "getBusinessStatus" }),
          });
          const result = await response.json();

          if (result.open) {
            container.className = "status-badge status-open";
            text.innerText = "Abierto";
          } else {
            container.className = "status-badge status-closed";
            text.innerText = "Cerrado";
            // Opcional: Podr√≠as deshabilitar el bot√≥n de enviar pedido si est√° cerrado
            // document.getElementById("sendOrderBtn").disabled = true;
          }
        } catch (error) {
          console.error("Error al obtener estado:", error);
          text.innerText = "Estado no disponible";
        }
      }

      // Llamar a la funci√≥n cuando cargue la p√°gina
      window.addEventListener("DOMContentLoaded", updateBusinessStatus);
    </script>
  </body>
</html>

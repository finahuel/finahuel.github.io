<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ice Cream Rolls ‚Äî Pedidos</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />

    <style>
      :root {
        --bg: #e7f6fa;
        --accent: #f46da0;
        --accent-2: #ffd66b;
        --card: #ffffff;
        --muted: #6b6b6b;
        --shadow: 0 10px 30px rgba(12, 12, 12, 0.06);
      }

      /* ============================
   RESET Y CONTENEDOR PRINCIPAL
============================= */
      * {
        box-sizing: border-box;
        max-width: 100%;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        overflow-x: hidden;
        scroll-behavior: smooth;
      }

      body {
        font-family: Inter, system-ui, "Helvetica Neue", Arial;
        background: linear-gradient(180deg, var(--bg) 0%, #ffffff 120%);
        -webkit-font-smoothing: antialiased;
        padding-top: 64px;
      }

      img {
        display: block;
      }

      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 18px;
      }
      header {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 10px 6px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
      }
      .logo {
        width: 72px;
        height: 72px;
        border-radius: 14px;
        flex: 0 0 72px;
        overflow: hidden;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
      }
      .lead {
        font-size: 13px;
        color: var(--muted);
        margin: 0;
      }

      /* GRID layout: columna principal flexible + sidebar hasta 380px */
      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 380px);
        gap: 18px;
        padding: 8px;
        align-items: start;
      }
      /* permitir que los hijos encogan (evita que un min-width interno rompa la grid) */
      .layout > * {
        min-width: 0;
      }

      /* Card */
      .card {
        background: #fff;
        padding: 14px;
        border-radius: 16px;
        box-shadow: var(--shadow);
      }

      /* Productos (grilla interna) */
      .products {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        min-width: 0;
      }

      .product {
        border-radius: 12px;
        overflow: hidden;
        background: #fffefc;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .product:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      }
      .product img {
        display: block;
        width: 100%;
        height: 150px;
        object-fit: cover;
        background: #f7f7f7;
        min-width: 0;
      }
      .product-body {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex: 1;
      }
      .product-title {
        font-weight: 700;
        font-size: 15px;
      }
      .price {
        font-weight: 800;
        color: var(--accent);
      }

      /* Buttons */
      .btn {
        padding: 8px 12px;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        font-weight: 700;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #fff;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid #ddd;
      }

      /* Modal */
      #modal {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        z-index: 120;
      }
      #modal .sheet {
        width: 100%;
        max-width: 760px;
        background: #fff;
        border-radius: 14px;
        padding: 14px;
        box-shadow: var(--shadow);
        max-height: 90vh;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }
      #modal img {
        width: 140px;
        height: 110px;
        object-fit: cover;
        border-radius: 8px;
      }

      /* Toppings / sauces */
      .topping-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
      }
      .chip {
        padding: 8px 10px;
        border-radius: 12px;
        border: 1px solid #eee;
        cursor: pointer;
        background: #fff;
      }
      .chip.active {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #fff;
        border-color: transparent;
      }
      .sauce-list {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .sauce {
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid #eee;
        cursor: pointer;
        background: #fff;
      }
      .sauce.active {
        background: var(--accent);
        color: white;
      }

      /* Carrito */
      .cart {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .cart-list {
        max-height: 320px;
        overflow: auto;
        padding-right: 6px;
      }
      .cart-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }

      /* Footer fijo */
      .fixed-footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        padding: 12px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 200;
        box-shadow: 0 -6px 18px rgba(12, 12, 12, 0.06);
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      .fixed-footer.visible {
        transform: translateY(0);
      }
      .fixed-total {
        font-weight: 800;
        font-size: 18px;
      }
      .fixed-button {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        color: #fff;
        padding: 12px 16px;
        border-radius: 12px;
        border: 0;
        font-weight: 800;
        cursor: pointer;
      }

      /* PAYMENT & FORM styling small */
      .payment-msg {
        font-size: 12px;
        color: var(--accent);
        margin-top: 4px;
        display: none;
      }

      /* nice form */
      .nice-form {
        display: flex;
        flex-direction: column;
        gap: 14px;
        background: #fdfdfd;
        border-radius: 16px;
        padding: 20px;
      }
      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .nice-form input,
      .nice-form select,
      .nice-form textarea {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #e2e2e2;
        font-size: 14px;
        background: #fff;
        box-shadow: inset 0 0 0 transparent;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }
      .nice-form input:focus,
      .nice-form select:focus,
      .nice-form textarea:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(244, 109, 160, 0.12);
        outline: none;
      }

      /* ============================
        NAVBAR FIJO (ACTUALIZADO)
        ============================ */
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 64px;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 20px;
      }

      .nav-inner {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-brand img {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        object-fit: cover;
      }

      .nav-text {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
      }

      .nav-text strong {
        font-size: 16px;
        font-weight: 700;
        color: #333;
      }

      .nav-text span {
        font-size: 12px;
        color: var(--muted);
      }

      .nav-actions {
        display: flex;
        gap: 12px;
      }

      .social-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid #e2e2e2;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 20px;
        text-decoration: none;
        color: #333;
      }

      .social-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .social-btn.instagram:hover {
        background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
        color: white;
        border-color: transparent;
      }

      .social-btn.whatsapp:hover {
        background: #25D366;
        color: white;
        border-color: transparent;
      }

      /* ============================
        BOTONES DE PRODUCTO - CORREGIDO
        ============================ */
      .product-foot {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        width: 100%;
      }

      .product-foot .price {
        flex: 0 0 auto;
        white-space: nowrap;
        font-weight: 800;
        color: var(--accent);
      }

      .product .btn-primary {
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        border: none;
        font-weight: 700;
        padding: 8px 16px;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        white-space: nowrap;
        min-width: 70px;
        margin: 0;
      }

      /* ============================
        RESPONSIVE
        ============================ */
      @media (max-width: 980px) {
        .layout {
          grid-template-columns: minmax(0, 1fr) !important;
          gap: 12px;
          padding: 12px;
        }
        .layout > * {
          width: 100%;
          min-width: 0 !important;
        }
        .products {
          grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
          gap: 10px;
        }
        .product img {
          height: 110px !important;
        }
        header .brand {
          flex-wrap: wrap;
        }
        body {
          padding-bottom: 120px;
        }
      }

      @media (max-width: 768px) {
        .products {
          grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
          gap: 12px;
        }
      }

      @media (max-width: 520px) {
        .product-foot {
          flex-direction: column;
          align-items: stretch;
          gap: 8px;
        }

        .product-foot .price {
          text-align: center;
          margin-bottom: 4px;
        }

        .product .btn-primary {
          width: 100%;
          text-align: center;
        }
        
        .products {
          grid-template-columns: repeat(2, 1fr);
          gap: 10px;
        }

        .product img {
          height: 120px !important;
        }
      }

      @media (max-width: 420px) {
        .product img {
          height: 100px !important;
        }
        .wrap {
          padding: 10px;
        }
        .card {
          padding: 12px;
          border-radius: 12px;
        }
      }

      /* Ajuste para footer visible */
      body.footer-visible {
        padding-bottom: 70px;
      }

      /* ============================
        MODAL MEJORADO
        ============================ */
      #modal {
        z-index: 2000;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }

      @media (max-width: 768px) {
        #modal {
          padding: 20px 10px;
          align-items: center;
          justify-content: center;
        }

        #modal .sheet {
          width: 95%;
          max-width: 500px;
          max-height: 85vh;
          border-radius: 16px;
          margin: 0 auto;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }

        #modal img {
          width: 100px;
          height: 80px;
        }

        .topping-grid {
          max-height: 150px;
          overflow-y: auto;
          padding-right: 5px;
        }

        .chip {
          padding: 8px 12px;
          font-size: 14px;
        }

        .actions-row {
          position: sticky;
          bottom: 0;
          background: white;
          padding: 15px 0 5px;
          border-top: 1px solid #eee;
          margin-top: 20px;
          z-index: 10;
        }
      }

      /* ============================
        SELECTOR DE CANTIDAD MEJORADO
        ============================ */
      .quantity-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
      }

      .qty-btn {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: 1px solid #e2e2e2;
        background: white;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .qty-btn:hover {
        background: #f5f5f5;
        border-color: var(--accent);
      }

      #modalQty {
        width: 80px;
        text-align: center;
        padding: 8px;
        border-radius: 10px;
        border: 1px solid #e2e2e2;
        font-size: 16px;
        font-weight: 700;
        background: #fff;
        -moz-appearance: textfield;
      }

      #modalQty::-webkit-outer-spin-button,
      #modalQty::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* ============================
        OPCI√ìN DE CUCHARITA
        ============================ */
      .cucharita-option {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 8px;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #e2e2e2;
        background: #fafafa;
      }

      .cucharita-option input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: var(--accent);
        cursor: pointer;
      }

      .cucharita-option label {
        font-size: 15px;
        cursor: pointer;
        flex: 1;
      }

      /* ============================
        ESTILOS PARA EL MAPA Y AUTOCOMPLETADO
        ============================ */
      #addressSuggestions {
        border: 1px solid #e2e2e2;
        border-radius: 10px;
        background: white;
        max-height: 200px;
        overflow-y: auto;
        position: absolute;
        width: 100%;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
      }

      .suggestion-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      }

      .suggestion-item:hover {
        background-color: #f7f7f7;
      }

      .address-input-container {
        position: relative;
      }

      /* Estilos para el modal del mapa */
      #mapModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        padding: 20px;
      }

      .map-container {
        background: white;
        border-radius: 20px;
        padding: 20px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #map {
        width: 100%;
        flex: 1;
        min-height: 400px;
        border-radius: 12px;
        margin: 15px 0;
      }

      .map-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
      }

      #selectedAddress {
        margin: 15px 0;
        padding: 10px;
        background: #f7f7f7;
        border-radius: 8px;
      }

      /* Bot√≥n para abrir el mapa */
      .open-map-btn {
        margin-top: 8px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* ============================
        MEJORAS DE LAYOUT
        ============================ */
      .layout {
        min-height: auto;
        align-items: stretch;
        margin-top: 20px;
        padding: 0 8px;
      }

      .layout > .card:first-child {
        display: flex;
        flex-direction: column;
      }

      #productsArea {
        flex: 1;
      }

      @media (min-width: 981px) {
        .layout {
          grid-template-columns: 1fr 380px;
          align-items: start;
        }

        .sidebar {
          position: sticky;
          top: 84px;
          max-height: calc(100vh - 100px);
          overflow-y: auto;
        }
      }

      .sidebar {
        overflow-y: auto;
      }

      /* Cart buttons */
      .cart-row .btn-ghost {
        font-size: 12px;
        padding: 5px 10px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
      }

      /* final safety: prevent global overflow horizontal */
      html,
      body,
      .wrap,
      .layout,
      .products,
      .card {
        min-width: 0;
      }
    </style>
  </head>

  <body>
    <!-- ===================================== -->
    <!-- NAVBAR CON BOTONES DE REDES SOCIALES  -->
    <!-- ===================================== -->
    <header class="navbar">
      <div class="nav-inner">
        <div class="nav-brand">
          <img src="img/logo.jpeg" alt="Thai Cream" />
          <div class="nav-text">
            <strong>Thai Cream</strong>
            <span>Posadas</span>
          </div>
        </div>

        <nav class="nav-actions">
          <a 
            href="https://instagram.com/tu-instagram" 
            target="_blank" 
            class="social-btn instagram"
            aria-label="Instagram"
            title="Instagram"
          >
            üì∑
          </a>
          <a 
            href="https://wa.me/5493764102637" 
            target="_blank" 
            class="social-btn whatsapp"
            aria-label="WhatsApp"
            title="WhatsApp"
          >
            üí¨
          </a>
        </nav>
      </div>
    </header>

    <div class="wrap">
      <div class="layout">
        <!-- COLUMNA IZQUIERDA: productos -->
        <div class="card">
          <h2>Eleg√≠ tus sabores</h2>
          <p class="lead" style="font-size: 13px">
            Pod√©s personalizar cada roll y agregar varios.
          </p>

          <div style="height: 10px"></div>

          <div id="productsArea" class="products"></div>
        </div>

        <!-- COLUMNA DERECHA: sidebar que contiene carrito + formulario -->
        <div class="sidebar">
          <!-- PANEL: Resumen / carrito -->
          <div class="card" style="margin-bottom: 12px">
            <h3 style="margin: 0 0 8px 0">Tu pedido</h3>
            <div id="cartList" class="cart-list">
              <div class="small" style="color: var(--muted)">
                No hay items todav√≠a
              </div>
            </div>

            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 12px;
              "
            >
              <div>
                <div class="small">Subtotal</div>
                <div id="total" style="font-weight: 800">$0</div>
              </div>
            </div>
          </div>

          <!-- FORMULARIO (debajo del carrito) -->
          <div id="customerForm" class="card nice-form">
            <h3 style="margin-top: 0">Datos del cliente</h3>

            <div class="form-field">
              <label>Nombre</label>
              <input id="custName" type="text" placeholder="Tu nombre" />
            </div>

            <div class="form-field">
              <label>Tel√©fono</label>
              <input id="custPhone" type="tel" placeholder="Ej: 3764xxxxxx" />
            </div>

            <div class="form-field">
              <label>Retiro o Entrega</label>
              <select id="deliveryMode">
                <option value="pickup">Retiro</option>
                <option value="delivery">Env√≠o a domicilio</option>
              </select>
            </div>

            <div id="addressBlock" class="form-field" style="display: none">
              <label>Direcci√≥n de entrega</label>
              <div class="address-input-container">
                <input
                  id="custAddress"
                  type="text"
                  placeholder="Comienza a escribir tu direcci√≥n..."
                  autocomplete="off"
                />
                <div id="addressSuggestions"></div>
              </div>
              <button 
                type="button" 
                id="openMapBtn" 
                class="btn btn-ghost open-map-btn"
              >
                üìç Seleccionar en el mapa
              </button>
              
              <!-- Campos adicionales para m√°s detalles -->
              <div class="form-field" style="margin-top: 12px;">
                <label>Departamento/Piso (opcional)</label>
                <input
                  id="custApt"
                  type="text"
                  placeholder="Ej: Piso 2, Depto B"
                />
              </div>
              
              <div class="form-field">
                <label>Referencia (opcional)</label>
                <input
                  id="custRef"
                  type="text"
                  placeholder="Ej: Port√≥n negro, timbre 'P√©rez'"
                />
              </div>
            </div>

            <div class="form-field">
              <label>M√©todo de pago</label>
              <select id="paymentMethod">
                <option value="cash">Efectivo</option>
                <option value="transfer">Transferencia</option>
              </select>

              <div id="paymentNotice" class="payment-msg">
                Para env√≠os solo aceptamos transferencia previa.
              </div>
            </div>

            <div class="form-field">
              <label>Notas (opcional)</label>
              <textarea
                id="custNotes"
                rows="2"
                placeholder="Ej: sin az√∫car / venir a tal hora"
              ></textarea>
            </div>

            <button
              id="checkoutBtn2"
              class="btn btn-primary"
              style="width: 100%; margin-top: 10px"
            >
              Enviar pedido
            </button>
          </div>
        </div>
        <!-- FIN SIDEBAR -->
      </div>
      <!-- END layout -->
    </div>
    <!-- END wrap -->

    <!-- Footer fijo mejorado -->
    <div class="fixed-footer" id="fixedFooter">
      <div
        class="footer-left"
        style="display: flex; align-items: center; gap: 12px"
      >
        <div style="font-weight: 800; font-size: 16px">
          Total: <span id="fixedTotal">$0</span>
        </div>
      </div>

      <div
        class="footer-actions"
        style="display: flex; gap: 8px; align-items: center"
      >
        <button
          id="footerAddBtn"
          class="btn btn-ghost"
          title="Agregar otro roll"
          style="padding: 8px 10px"
        >
          Men√∫
        </button>
        <button
          id="footerFormBtn"
          class="btn btn-ghost"
          title="Completar datos"
          style="padding: 8px 10px"
        >
          Cliente
        </button>
        <button
          id="footerClearBtn"
          class="btn btn-ghost"
          title="Vaciar carrito"
          style="padding: 8px 10px"
        >
          Vaciar
        </button>
        <button
          id="fixedSendBtn"
          class="fixed-button"
          style="padding: 10px 14px"
        >
          Enviar pedido
        </button>
      </div>
    </div>

    <!-- Modal para personalizar productos -->
    <div id="modal">
      <div class="sheet">
        <div style="display: flex; gap: 14px; align-items: center">
          <img id="modalImg" src="" />
          <div>
            <h2
              id="modalTitle"
              style="margin: 0; font-size: 18px; font-weight: 700"
            ></h2>
          </div>
        </div>

        <h3 style="margin-top: 18px">Toppings</h3>
        <div id="modalToppings" class="topping-grid"></div>
        <div class="lead" style="font-size: 12px; color: #777; margin-top: 4px">
          El primer topping es gratis
        </div>

        <h3 style="margin-top: 18px">Salsas</h3>
        <div id="modalSauces" class="sauce-list">
          <div class="sauce" data-s="Chocolate">Chocolate</div>
          <div class="sauce" data-s="Dulce de leche">Dulce de leche</div>
          <div class="sauce" data-s="Frutilla">Frutilla</div>
          <div class="sauce" data-s="Caramelo">Caramelo</div>
        </div>

        <h3 style="margin-top: 18px">Cantidad</h3>
        <div class="quantity-selector">
          <button id="decreaseQty" type="button" class="qty-btn">-</button>
          <input
            id="modalQty"
            type="number"
            min="1"
            value="1"
          />
          <button id="increaseQty" type="button" class="qty-btn">+</button>
        </div>

        <h3 style="margin-top: 18px">Cucharita</h3>
        <div class="cucharita-option">
          <input type="checkbox" id="cucharitaCheckbox">
          <label for="cucharitaCheckbox">S√≠, incluir cucharita</label>
        </div>

        <div
          class="actions-row"
          style="
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 14px;
            align-items: center;
          "
        >
          <div
            id="modalLinePrice"
            style="font-weight: 700; color: var(--accent)"
          >
            $0
          </div>
          <button id="addToCartBtn" class="btn btn-primary">
            Agregar 
          </button>
          <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal para el mapa -->
    <div id="mapModal">
      <div class="map-container">
        <h3 style="margin: 0 0 15px 0">Seleccion√° tu ubicaci√≥n en el mapa</h3>
        <div id="map"></div>
        <div id="selectedAddress">
          <div style="font-weight: 600; margin-bottom: 5px;">Direcci√≥n seleccionada:</div>
          <div id="addressText" style="color: #666;">Hac√© clic en el mapa para seleccionar una ubicaci√≥n</div>
        </div>
        <div class="map-actions">
          <button id="confirmAddress" class="btn btn-primary">Usar esta direcci√≥n</button>
          <button id="closeMap" class="btn btn-ghost">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- ======================= -->
    <!--        JAVASCRIPT       -->
    <!-- ======================= -->

    <!-- Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      /* CONFIG */
      const PHONE = "5493764102637";
      const BASE_PRICE_DEFAULT = 2500;
      const TOPPING_EXTRA_PRICE = 300;

      /* Productos (con misma imagen) */
      const flavors = [
        { id: "oreo", name: "Oreo", price: 2500, img: "img/oreo.jpeg" },
        { id: "dura", name: "Durazno", price: 2500, img: "img/oreo.jpeg" },
        { id: "fruit", name: "Frutilla", price: 2500, img: "img/oreo.jpeg" },
        { id: "chocot", name: "Chocotorta", price: 2500, img: "img/oreo.jpeg" },
        { id: "pepi", name: "Pepitos", price: 2500, img: "img/oreo.jpeg" },
        { id: "mara", name: "Maracuya", price: 2500, img: "img/oreo.jpeg" },
        { id: "bana", name: "Banana", price: 2500, img: "img/oreo.jpeg" },
      ];

      const toppings = [
        "Man√≠",
        "Gomitas",
        "Chips de chocolate",
        "Oreo",
        "Rocklets",
        "Coco rallado",
        "Merenguitos",
        "Pepitos",
        "Chocolinas",
      ];

      let cart = [];
      let editingItemId = null;
      let currentFlavor = null;
      let isSubmitting = false;

      // Variables para el mapa
      let map = null;
      let marker = null;
      let selectedLocation = null;
      let selectedAddress = "";

      /* Helpers */
      function $(s) {
        return document.querySelector(s);
      }
      function $$(s) {
        return document.querySelectorAll(s);
      }
      function fmt(n) {
        return "$" + Number(n).toLocaleString("es-AR");
      }

      /* Funci√≥n simple: mostrar footer solo si hay productos */
      function updateFooter() {
        const footer = document.getElementById("fixedFooter");
        const body = document.body;

        if (!footer) return;

        if (cart.length > 0) {
          footer.classList.add("visible");
          body.classList.add("footer-visible");
        } else {
          footer.classList.remove("visible");
          body.classList.remove("footer-visible");
        }
      }

      /* Render productos */
      function renderProducts() {
        const area = $("#productsArea");
        area.innerHTML = "";
        flavors.forEach((f) => {
          const box = document.createElement("div");
          box.className = "product";
          box.innerHTML = `
            <img src="${
              f.img
            }" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x300?text=Ice+Cream'">
            <div class="product-body">
                <div class="product-title">${f.name}</div>
                <div class="product-foot">
                    <div class="price">${fmt(f.price)}</div>
                    <button class="btn btn-primary" onclick="startNewModal('${
                      f.id
                    }','${f.name}')">Armar</button>
                </div>
            </div>
        `;
          area.appendChild(box);
        });
      }

      // Helper: abrir modal para CREAR un nuevo √≠tem
      function startNewModal(id, name) {
        editingItemId = null;
        openModal(id, name);
      }

      // Modal para personalizar
      function openModal(id, name) {
        currentFlavor = flavors.find((f) => f.id === id);

        $("#modalTitle").textContent = name;
        $("#modalImg").src = currentFlavor.img;
        $("#modalQty").value = 1;

        // Configurar botones de cantidad
        const decreaseBtn = $("#decreaseQty");
        const increaseBtn = $("#increaseQty");
        const qtyInput = $("#modalQty");

        decreaseBtn.onclick = () => {
          let current = parseInt(qtyInput.value);
          if (current > 1) {
            qtyInput.value = current - 1;
            updateModalPrice();
          }
        };

        increaseBtn.onclick = () => {
          let current = parseInt(qtyInput.value);
          qtyInput.value = current + 1;
          updateModalPrice();
        };

        // toppings
        const t = $("#modalToppings");
        t.innerHTML = "";
        toppings.forEach((tp) => {
          const el = document.createElement("label");
          el.className = "chip";
          el.innerHTML = `<input type="checkbox" value="${tp}"> ${tp}`;
          el.querySelector("input").addEventListener(
            "change",
            updateModalPrice
          );
          t.appendChild(el);
        });

        // sauces
        $("#modalSauces")
          .querySelectorAll(".sauce")
          .forEach((s) => {
            s.classList.remove("active");
            s.onclick = () => {
              $("#modalSauces")
                .querySelectorAll(".sauce")
                .forEach((x) => x.classList.remove("active"));
              s.classList.add("active");
              updateModalPrice();
            };
          });

        // Resetear cucharita
        $("#cucharitaCheckbox").checked = false;

        updateModalPrice();

        $("#modal").style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeModal() {
        $("#modal").style.display = "none";
        document.body.style.overflow = "auto";
      }

      function updateModalPrice() {
        const qty = Math.max(1, parseInt($("#modalQty").value || "1"));
        const checked = [
          ...$("#modalToppings").querySelectorAll("input:checked"),
        ].map((i) => i.value);
        const extra = Math.max(0, checked.length - 1) * TOPPING_EXTRA_PRICE;
        $("#modalLinePrice").textContent = fmt(
          (currentFlavor.price + extra) * qty
        );
      }

      /* Add to cart */
      $("#addToCartBtn").onclick = () => {
        const qty = Math.max(1, parseInt($("#modalQty").value || "1"));
        const selectedToppings = [
          ...$("#modalToppings").querySelectorAll("input:checked"),
        ].map((i) => i.value);
        const sauceEl = $("#modalSauces").querySelector(".sauce.active");
        const sauce = sauceEl ? sauceEl.dataset.s : "";
        const cucharita = $("#cucharitaCheckbox").checked;

        const extraPerUnit =
          Math.max(0, selectedToppings.length - 1) * TOPPING_EXTRA_PRICE;
        const itemTotal = (currentFlavor.price + extraPerUnit) * qty;

        if (editingItemId) {
          const it = cart.find((x) => x.id === editingItemId);
          it.qty = qty;
          it.toppings = selectedToppings;
          it.sauce = sauce;
          it.cucharita = cucharita;
          it.unitPrice = currentFlavor.price;
        } else {
          cart.push({
            id: "i" + Date.now(),
            flavorName: currentFlavor.name,
            flavorId: currentFlavor.id,
            qty: qty,
            toppings: selectedToppings,
            sauce: sauce,
            cucharita: cucharita,
            unitPrice: currentFlavor.price,
          });
        }

        closeModal();
        renderCart();
      };

      /* Render cart */
      function calcItemTotal(it) {
        const extra = Math.max(0, it.toppings.length - 1) * TOPPING_EXTRA_PRICE;
        return (it.unitPrice + extra) * it.qty;
      }

      function renderCart() {
        const list = $("#cartList");

        // Calculamos total
        let total = 0;
        cart.forEach((it) => (total += calcItemTotal(it)));

        if (!list) {
          const fixedEl = document.getElementById("fixedTotal");
          if (fixedEl) fixedEl.textContent = fmt(total);
          updateFooter();
          return;
        }

        // Renderizar filas del carrito
        list.innerHTML = "";

        if (cart.length === 0) {
          list.innerHTML =
            '<div class="small" style="color:var(--muted)">No hay items todav√≠a</div>';
        } else {
          cart.forEach((it) => {
            const row = document.createElement("div");
            row.className = "cart-row";
            row.innerHTML = `
                  <div>
                      <b>${it.qty}√ó ${it.flavorName}</b><br>
                      <span class="small">${
                        it.toppings && it.toppings.length
                          ? it.toppings.join(", ")
                          : "Sin toppings"
                      } ‚Ä¢ ${it.sauce || "Sin salsa"}</span><br>
                      <span class="small" style="color: ${
                        it.cucharita ? "var(--accent)" : "#777"
                      }; font-weight: ${it.cucharita ? "600" : "400"}">
                        ${it.cucharita ? "‚úì Con cucharita" : "‚úó Sin cucharita"}
                      </span>
                  </div>
                  <div style="text-align:right">
                      <b>${fmt(calcItemTotal(it))}</b><br>
                      <button class="btn btn-ghost" style="margin-top:6px;font-size:12px" onclick="editItem('${
                        it.id
                      }')">Editar</button>
                      <button class="btn btn-ghost" style="margin-top:6px;font-size:12px" onclick="removeItem('${
                        it.id
                      }')">Eliminar</button>
                  </div>
              `;
            list.appendChild(row);
          });
        }

        // Actualizar totales
        const totalEl = document.getElementById("total");
        if (totalEl) totalEl.textContent = fmt(total);

        const fixedEl = document.getElementById("fixedTotal");
        if (fixedEl) fixedEl.textContent = fmt(total);

        updateFooter();
      }

      function editItem(id) {
        editingItemId = id;
        const it = cart.find((x) => x.id === id);
        openModal(it.flavorId, it.flavorName);

        $("#modalQty").value = it.qty;
        $("#cucharitaCheckbox").checked = it.cucharita || false;

        // toppings
        $("#modalToppings")
          .querySelectorAll("input")
          .forEach((ch) => {
            if (it.toppings.includes(ch.value)) ch.checked = true;
          });

        // sauce
        $("#modalSauces")
          .querySelectorAll(".sauce")
          .forEach((s) => {
            if (s.dataset.s === it.sauce) s.classList.add("active");
          });

        updateModalPrice();
      }

      function removeItem(id) {
        cart = cart.filter((x) => x.id !== id);
        renderCart();
      }

      /* Delivery select: direcci√≥n + reglas de pago */
      $("#deliveryMode").onchange = () => {
        const mode = $("#deliveryMode").value;
        const addr = $("#addressBlock");
        const pay = document.getElementById("paymentMethod");
        const notice = document.getElementById("paymentNotice");
        const cashOpt = pay.querySelector('option[value="cash"]');

        // Mostrar/ocultar direcci√≥n
        addr.style.display = mode === "delivery" ? "block" : "none";

        if (mode === "delivery") {
          // Forzar transferencia
          pay.value = "transfer";
          if (cashOpt) cashOpt.disabled = true;

          // Mostrar aviso
          notice.style.display = "block";
        } else {
          // Habilitar efectivo nuevamente
          if (cashOpt) cashOpt.disabled = false;

          // Ocultar aviso
          notice.style.display = "none";
        }
      };

      /* ============================================
        FUNCIONALIDAD DE DIRECCI√ìN CON OPENSTREETMAP
        ============================================ */

      // Autocompletado de direcciones usando Nominatim
      let addressTimeout = null;
      $("#custAddress").addEventListener("input", function(e) {
        const query = e.target.value.trim();
        
        if (addressTimeout) {
          clearTimeout(addressTimeout);
        }
        
        if (query.length < 3) {
          $("#addressSuggestions").style.display = "none";
          return;
        }
        
        addressTimeout = setTimeout(() => {
          searchAddresses(query);
        }, 300);
      });

      document.addEventListener("click", function(e) {
        if (!e.target.closest(".address-input-container")) {
          $("#addressSuggestions").style.display = "none";
        }
      });

      function searchAddresses(query) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Posadas, Misiones, Argentina')}&limit=5&addressdetails=1`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            displayAddressSuggestions(data);
          })
          .catch(error => {
            console.error("Error buscando direcciones:", error);
          });
      }

      function displayAddressSuggestions(addresses) {
        const container = $("#addressSuggestions");
        container.innerHTML = "";
        
        if (addresses.length === 0) {
          container.style.display = "none";
          return;
        }
        
        addresses.forEach(addr => {
          const div = document.createElement("div");
          div.className = "suggestion-item";
          div.textContent = addr.display_name;
          div.addEventListener("click", function() {
            $("#custAddress").value = addr.display_name;
            container.style.display = "none";
            
            selectedLocation = {
              lat: parseFloat(addr.lat),
              lng: parseFloat(addr.lon)
            };
            selectedAddress = addr.display_name;
          });
          container.appendChild(div);
        });
        
        container.style.display = "block";
      }

      // Inicializar mapa
      function initMap() {
        const posadasCoords = [-27.3671, -55.8961];
        
        map = L.map('map').setView(posadasCoords, 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        marker = L.marker(posadasCoords, {draggable: true}).addTo(map);
        selectedLocation = {lat: posadasCoords[0], lng: posadasCoords[1]};
        
        updateAddressFromMarker();
        
        marker.on('dragend', function(e) {
          selectedLocation = {
            lat: e.target.getLatLng().lat,
            lng: e.target.getLatLng().lng
          };
          updateAddressFromMarker();
        });
        
        map.on('click', function(e) {
          selectedLocation = {
            lat: e.latlng.lat,
            lng: e.latlng.lng
          };
          marker.setLatLng(e.latlng);
          updateAddressFromMarker();
        });
      }

      function updateAddressFromMarker() {
        if (!selectedLocation) return;
        
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedLocation.lat}&lon=${selectedLocation.lng}&zoom=18&addressdetails=1`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.display_name) {
              selectedAddress = data.display_name;
              $("#addressText").textContent = selectedAddress;
            }
          })
          .catch(error => {
            console.error("Error obteniendo direcci√≥n:", error);
            $("#addressText").textContent = "Error obteniendo la direcci√≥n. Por favor, intent√° nuevamente.";
          });
      }

      // Abrir modal del mapa
      $("#openMapBtn").addEventListener("click", function() {
        $("#mapModal").style.display = "flex";
        document.body.style.overflow = "hidden";
        
        if (!map) {
          initMap();
        }
      });

      // Cerrar modal del mapa
      $("#closeMap").addEventListener("click", function() {
        $("#mapModal").style.display = "none";
        document.body.style.overflow = "auto";
      });

      // Confirmar direcci√≥n seleccionada en el mapa
      $("#confirmAddress").addEventListener("click", function() {
        if (selectedAddress) {
          $("#custAddress").value = selectedAddress;
          $("#mapModal").style.display = "none";
          document.body.style.overflow = "auto";
        } else {
          alert("Por favor, seleccion√° una ubicaci√≥n en el mapa.");
        }
      });

      $("#mapModal").addEventListener("click", function(e) {
        if (e.target.id === "mapModal") {
          $("#mapModal").style.display = "none";
          document.body.style.overflow = "auto";
        }
      });

      /* WhatsApp */
      function sendWhatsApp() {
        if (isSubmitting) return;
        isSubmitting = true;
        
        setTimeout(() => {
          isSubmitting = false;
        }, 1000);

        if (cart.length === 0) {
          alert("Tu carrito est√° vac√≠o.");
          scrollToProducts();
          isSubmitting = false;
          return;
        }

        let name = $("#custName").value.trim();
        let phone = $("#custPhone").value.trim();
        if (!name) {
          alert("Ingres√° tu nombre.");
          scrollToForm();
          isSubmitting = false;
          return;
        }
        if (!phone) {
          alert("Ingres√° tu tel√©fono.");
          scrollToForm();
          isSubmitting = false;
          return;
        }

        let mode = $("#deliveryMode").value;
        let address = $("#custAddress").value.trim();

        if (mode === "delivery" && !address) {
          alert("Ingres√° la direcci√≥n.");
          scrollToForm();
          isSubmitting = false;
          return;
        }

        let pay = $("#paymentMethod").value;
        let notes = $("#custNotes").value.trim();
        let apt = $("#custApt").value.trim();
        let ref = $("#custRef").value.trim();

        // Construir mensaje
        let text = "Nuevo pedido\n\n";
        cart.forEach((it, i) => {
          text += `${i + 1}) ${it.qty}√ó ${it.flavorName}\n`;
          text += `Toppings: ${
            it.toppings && it.toppings.length
              ? it.toppings.join(", ")
              : "Sin toppings"
          }\n`;
          text += `Salsa: ${it.sauce || "Sin salsa"}\n`;
          text += `Cucharita: ${it.cucharita ? "S√≠" : "No"}\n`;
          text += `Subtotal: ${fmt(calcItemTotal(it))}\n\n`;
        });

        const totalAmount = cart.reduce((s, it) => s + calcItemTotal(it), 0);
        text += `Total: ${fmt(totalAmount)}\n\n`;
        text += `Cliente: ${name}\nTel: ${phone}\n`;
        text += `Entrega: ${mode === "pickup" ? "Retiro" : "Env√≠o"}\n`;
        if (mode === "delivery") {
          text += `Direcci√≥n: ${address}\n`;
          if (apt) text += `Departamento/Piso: ${apt}\n`;
          if (ref) text += `Referencia: ${ref}\n`;
        }
        text += `Pago: ${pay === "cash" ? "Efectivo" : "Transferencia"}\n`;
        if (notes) text += `Notas: ${notes}\n`;

        // abrir WhatsApp
        const url = `https://wa.me/${PHONE}?text=` + encodeURIComponent(text);
        window.open(url, "_blank");
        isSubmitting = false;
      }

      /* Funciones de scroll */
      function scrollToProducts() {
        const productsSection = document.querySelector(".layout");
        if (productsSection) {
          productsSection.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }

      function scrollToForm() {
        const el = document.getElementById("customerForm");
        if (el) {
          el.scrollIntoView({ 
            behavior: "smooth", 
            block: "start" 
          });
          el.style.boxShadow = "0 0 0 3px rgba(244, 109, 160, 0.3)";
          setTimeout(() => {
            el.style.boxShadow = "";
          }, 1500);
        }
      }

      function clearCart() {
        if (!cart || !cart.length) return;
        if (!confirm("¬øVaciar el carrito?")) return;
        cart = [];
        renderCart();
      }

      /* INIT */
      document.addEventListener("DOMContentLoaded", function () {
        // Hook botones del footer
        const addBtn = document.getElementById("footerAddBtn");
        if (addBtn) addBtn.addEventListener("click", scrollToProducts);

        const formBtn = document.getElementById("footerFormBtn");
        if (formBtn) formBtn.addEventListener("click", scrollToForm);

        const clearBtn = document.getElementById("footerClearBtn");
        if (clearBtn) clearBtn.addEventListener("click", clearCart);

        // Solo un event listener para el bot√≥n fijo
        const fixedSendBtn = document.getElementById("fixedSendBtn");
        if (fixedSendBtn) {
          fixedSendBtn.removeEventListener("click", sendWhatsApp);
          fixedSendBtn.addEventListener("click", sendWhatsApp);
        }

        // Solo un event listener para el bot√≥n del formulario
        const checkoutBtn2 = document.getElementById("checkoutBtn2");
        if (checkoutBtn2) {
          checkoutBtn2.removeEventListener("click", sendWhatsApp);
          checkoutBtn2.addEventListener("click", sendWhatsApp);
        }

        // Inicializar componentes
        renderProducts();
        renderCart();
        updateFooter();
      });
    </script>
  </body>
</html>
